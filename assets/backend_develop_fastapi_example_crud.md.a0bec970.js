import{_ as s,o as a,c as n,a as l}from"./app.5bb4edff.js";const e="/assets/database.ef78f579.png",h=JSON.parse('{"title":"與資料庫對話 ( 範例 CRUD )","description":"","frontmatter":{},"headers":[{"level":2,"title":"環境安裝","slug":"環境安裝","link":"#環境安裝","children":[]},{"level":2,"title":"創建需要文件說明","slug":"創建需要文件說明","link":"#創建需要文件說明","children":[]},{"level":2,"title":"Read 讀取 ( get )","slug":"read-讀取-get","link":"#read-讀取-get","children":[{"level":3,"title":"共用核對欄位 ( schema.py )","slug":"共用核對欄位-schema-py","link":"#共用核對欄位-schema-py","children":[]},{"level":3,"title":"方法建立 ( crud.py )","slug":"方法建立-crud-py","link":"#方法建立-crud-py","children":[]},{"level":3,"title":"引入所有處理資料的檔案 ( main.py )","slug":"引入所有處理資料的檔案-main-py","link":"#引入所有處理資料的檔案-main-py","children":[]},{"level":3,"title":"參考","slug":"參考","link":"#參考","children":[]}]}],"relativePath":"backend_develop/fastapi/example_crud.md","lastUpdated":null}'),p={name:"backend_develop/fastapi/example_crud.md"},o=l('<h1 id="與資料庫對話-範例-crud" tabindex="-1">與資料庫對話 ( 範例 CRUD ) <a class="header-anchor" href="#與資料庫對話-範例-crud" aria-hidden="true">#</a></h1><p>延續幾篇內容，以連接 mysql 直接製作常見的範例CRUD。</p><h2 id="環境安裝" tabindex="-1">環境安裝 <a class="header-anchor" href="#環境安裝" aria-hidden="true">#</a></h2><ul><li>venv</li><li>FastAPI、Uvicorn、Sqlalchemy</li><li>pymysql 或其他連接sql的模組 ( 例如 : mysql-connector-python )</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>如果是sqlite db不需要安裝其他模組</p></div><h2 id="創建需要文件說明" tabindex="-1">創建需要文件說明 <a class="header-anchor" href="#創建需要文件說明" aria-hidden="true">#</a></h2><p>前幾篇文中都一直在提到下方這兩個檔案內容周旋。</p><ul><li><code>database.py</code> 連結資料庫的設定檔(帳號、密碼、資料庫名)。</li><li><code>model.py</code> 資料表模組 ( 資料表名<code>__tablename__</code>、欄位<code>Column</code>、類型<code>type</code>、關聯性<code>relationship</code> )。</li></ul><p>這段開始則以另外這兩份表作為闡述。</p><ul><li><code>schema.py</code> 用來查核或檢測輸入類別與資料表是否對應。</li><li><code>crud.py</code> 處理資料表(例如:取得資料表、篩選、創建資料表等方法)。</li></ul><p>最後使用<code>post</code>、<code>get</code>、<code>put</code>、<code>delete</code>路由導入到<code>main.py</code>中，就像下方的關聯圖一樣，最終紅色箭頭的指向。 <img src="'+e+`" alt="er_diagram"></p><h2 id="read-讀取-get" tabindex="-1">Read 讀取 ( get ) <a class="header-anchor" href="#read-讀取-get" aria-hidden="true">#</a></h2><p>萬事起頭<code>get</code>，先從讀取資料開始，順便測試能否連上資料表。</p><h3 id="共用核對欄位-schema-py" tabindex="-1">共用核對欄位 ( <a href="http://schema.py" target="_blank" rel="noreferrer">schema.py</a> ) <a class="header-anchor" href="#共用核對欄位-schema-py" aria-hidden="true">#</a></h3><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># schema.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> pydantic </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> BaseModel</span></span>
<span class="line"></span></code></pre></div><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># schema.py</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Schema_item</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">BaseModel</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span></span>
<span class="line"><span style="color:#A6ACCD;">    ppcode</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">str</span></span>
<span class="line"></span></code></pre></div><hr><h3 id="方法建立-crud-py" tabindex="-1">方法建立 ( <a href="http://crud.py" target="_blank" rel="noreferrer">crud.py</a> ) <a class="header-anchor" href="#方法建立-crud-py" aria-hidden="true">#</a></h3><p>先引入<code>sqlalchemy模組</code>與<code>models、schema</code>設定好的資料庫連接內容</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># crud.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">orm </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Session</span></span>
<span class="line"></span></code></pre></div><p>引入自訂義<code>crud、schema</code>模組</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># crud.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> models </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> products</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> schema</span></span>
<span class="line"></span></code></pre></div><p>這裡定義取用方法，使用<code>Session</code>與資料庫對話，定義<code>get_start</code>起始值、<code>the_end</code>結束值。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># crud.py</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_db_s</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">get_start</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">the_end</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">):</span></span>
<span class="line"></span></code></pre></div><p>回饋值，採<code>models</code>自訂義模組的資料表，顯示起訖數值。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># crud.py</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">products</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">offset</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_start</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">limit</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">the_end</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">all</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><hr><h3 id="引入所有處理資料的檔案-main-py" tabindex="-1">引入所有處理資料的檔案 ( <a href="http://main.py" target="_blank" rel="noreferrer">main.py</a> ) <a class="header-anchor" href="#引入所有處理資料的檔案-main-py" aria-hidden="true">#</a></h3><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> models</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> schema</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> database </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> SessionLocal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> engine</span></span>
<span class="line"></span></code></pre></div><p>開啟資料庫</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#A6ACCD;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Base</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_all</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">bind</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">engine</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>讓session與資料庫對話，並確保取得資料後即關閉，避免資源消耗。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    db </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SessionLocal</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> db</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p>建立路由，這裡兩個路由差異在於 <code>{ id }</code>、 <code>list</code> 參數，雖然都是使用相同的 schema function，差異僅在於取樣數據為單一或多數。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 多項數據</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">list</span><span style="color:#89DDFF;">[</span><span style="color:#82AAFF;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">class</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 單項數據 (指定id)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path/</span><span style="color:#F78C6C;">{id}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h4 id="多項數據我把它分成3段說明" tabindex="-1">多項數據我把它分成3段說明 : <a class="header-anchor" href="#多項數據我把它分成3段說明" aria-hidden="true">#</a></h4><ol><li>定義路由 : 這裡在路由後方塞了一個重點<code>response_model</code>，使用清單<code>list[]</code>方式，顯示<code>schema</code>定義的選項。</li></ol><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">list</span><span style="color:#89DDFF;">[</span><span style="color:#82AAFF;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">schema_item</span><span style="color:#89DDFF;">])</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>定義方法 : 建立取用資料筆數<code>get_start、the_end</code>和<code>Session</code>啟動資料庫對話</li></ol><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_db_s</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">get_start</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">the_end</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">Depends</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"></span></code></pre></div><ol start="3"><li>取用資料庫 : 將使用<code>crud</code>自訂義模組來對資料庫動作<code>get_db_s</code>，最後<code>return</code>回饋處理過的數據。</li></ol><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#A6ACCD;">  get_db </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_db_s </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db </span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">get_start</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">get_start </span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">the_end</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">the_end</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> get_db</span></span>
<span class="line"></span></code></pre></div><hr><h4 id="單項數據" tabindex="-1">單項數據 : <a class="header-anchor" href="#單項數據" aria-hidden="true">#</a></h4><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># main.py</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/path/</span><span style="color:#F78C6C;">{id}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">function</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><hr><h3 id="參考" tabindex="-1">參考 <a class="header-anchor" href="#參考" aria-hidden="true">#</a></h3><ul><li><a href="https://ahmed-nafies.medium.com/tutorial-fastapi-with-sqlalchemy-async-orm-and-alembic-2fa68102f82d" target="_blank" rel="noreferrer">FastAPI with SQLAlchemy Async ORM and Alembic</a></li><li><a href="https://codevoweb.com/crud-restful-api-server-with-python-fastapi-and-mongodb/" target="_blank" rel="noreferrer">CRUD RESTful API Server with Python, FastAPI, and MongoDB</a></li><li><a href="https://codevoweb.com/crud-restful-api-server-with-python-fastapi-and-postgresql/" target="_blank" rel="noreferrer">CRUD RESTful API Server with Python, FastAPI, and PostgreSQL</a></li><li><a href="https://www.youtube.com/watch?v=dJ4GiwNtvSw" target="_blank" rel="noreferrer"> FastAPI | MYSQL (CRUD Operation)</a></li></ul>`,48),t=[o];function c(r,i,y,F,d,D){return a(),n("div",null,t)}const C=s(p,[["render",c]]);export{h as __pageData,C as default};
