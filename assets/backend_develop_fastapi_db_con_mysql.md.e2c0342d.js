import{_ as s,c as a,o as n,d as l}from"./app.5a2dc0fe.js";const p="/assets/database_products.0aa71356.png",d=JSON.parse('{"title":"與資料庫對話(MySQL)篇","description":"","frontmatter":{},"headers":[{"level":2,"title":"環境安裝","slug":"環境安裝","link":"#環境安裝","children":[]},{"level":2,"title":"與資料庫連線(database.py)","slug":"與資料庫連線-database-py","link":"#與資料庫連線-database-py","children":[]},{"level":2,"title":"建立資料表 ( models.py )","slug":"建立資料表-models-py","link":"#建立資料表-models-py","children":[]},{"level":2,"title":"執行看看結果","slug":"執行看看結果","link":"#執行看看結果","children":[]}],"relativePath":"backend_develop/fastapi/db_con_mysql.md","lastUpdated":null}'),o={name:"backend_develop/fastapi/db_con_mysql.md"},e=l(`<h1 id="與資料庫對話-mysql-篇" tabindex="-1">與資料庫對話(MySQL)篇 <a class="header-anchor" href="#與資料庫對話-mysql-篇" aria-hidden="true">#</a></h1><p>上一篇建立是本機的資料庫，這篇來使用 <code>pymysql</code> 模組連線資料庫。</p><p>我手頭上收到一組.sql檔案，使用xampp來匯入並模擬線上phpmysql，這代表必須事先了解這資料庫的每個資料表欄位類型，才能確保連線後的動作是否正確。</p><h2 id="環境安裝" tabindex="-1">環境安裝 <a class="header-anchor" href="#環境安裝" aria-hidden="true">#</a></h2><ul><li>Sqlalchemy</li><li>Pymysql</li></ul><div class="language-cmd"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">pip install sqlalchemy pymysql</span></span>
<span class="line"></span></code></pre></div><h2 id="與資料庫連線-database-py" tabindex="-1">與資料庫連線(<a href="http://database.py" target="_blank" rel="noreferrer">database.py</a>) <a class="header-anchor" href="#與資料庫連線-database-py" aria-hidden="true">#</a></h2><p>基本上與上一篇大同小異，僅差在 <code>URL</code> 及 <code>connect_args</code> 不同。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> create_engine</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ext</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">declarative </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> declarative_base</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">orm </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> sessionmaker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">DATABASE_URL </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mysql+pymysql://root@localhost:3306/product_sql</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">engine </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">create_engine</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    DATABASE_URL</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">connect_args</span><span style="color:#89DDFF;">={}</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SessionLocal </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sessionmaker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">autocommit</span><span style="color:#89DDFF;">=False,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">autoflush</span><span style="color:#89DDFF;">=False,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bind</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">engine</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">Base </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">declarative_base</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p>解釋一下 pymysql 連線設定 :</p><p><code>mysql + pymysql : // {帳號} : {密碼} @ {路徑} : {port} / {資料表}</code></p><p>如果沒有密碼就不要輸入資料，就像範例一樣。</p><h2 id="建立資料表-models-py" tabindex="-1">建立資料表 ( <a href="http://models.py" target="_blank" rel="noreferrer">models.py</a> ) <a class="header-anchor" href="#建立資料表-models-py" aria-hidden="true">#</a></h2><p>承如上一開始所敘述由於是要連線到已經存在的資料庫內，所必須了解原數據類型，以免產生不必要的錯誤，以下是我收到的資料庫其中一份資料表內容。 <img src="`+p+`" alt="old_db"></p><p>先引入 <code>sqlalchemy</code> 所支援的欄位類型，可參考下方連結 :</p><ul><li><a href="https://docs.sqlalchemy.org/en/20/core/types.html" target="_blank" rel="noreferrer">Sqlalchemy 資料類型</a></li></ul><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Column</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">  Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> DateTime</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Text</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">Float</span></span>
<span class="line"></span></code></pre></div><p>引入上一段資料庫連線模組 <code>database.py</code>內的 <code>Base</code></p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> database </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Base</span></span>
<span class="line"></span></code></pre></div><p>開始針對資料表欄位舉出類型，可參考下方兩個連結確認支援類型。</p><ul><li><a href="https://docs.pydantic.dev/usage/types/" target="_blank" rel="noreferrer">Pydantic 資料類型</a></li></ul><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">products</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Base</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    __tablename__ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">products</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">primary_key</span><span style="color:#89DDFF;">=True,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">index</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">    ppcode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">unique</span><span style="color:#89DDFF;">=True,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">index</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">    psecode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    barcode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">255</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    weight </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Float</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    remark </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">255</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    title </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">255</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    description </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Text</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    create_date </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">DateTime</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    last_modify </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">DateTime</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    approve_date </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">DateTime</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    origincode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">255</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    parent_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    product_type </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    purchase_status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    import_status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    total_sell </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    total_rma </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>這串是針對與數個資料表的某個欄位相互對應所用，如果沒有可省略。</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">   items </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">relationship</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Item</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">back_populates</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">owner</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h2 id="執行看看結果" tabindex="-1">執行看看結果 <a class="header-anchor" href="#執行看看結果" aria-hidden="true">#</a></h2><p>如過無法連線，常見有問題有以下幾種 :</p><ul><li>mysql伺服器是否運作。</li><li>連線資料 (帳號、密碼、資料庫名稱) 是否正確。</li><li>資料表欄位類型、名稱是否正確。</li><li>引入 <code>資料庫連線模組</code> 的 <code>路徑</code> 是否正確。</li></ul>`,27),t=[e];function c(r,y,F,D,A,i){return n(),a("div",null,t)}const m=s(o,[["render",c]]);export{d as __pageData,m as default};
