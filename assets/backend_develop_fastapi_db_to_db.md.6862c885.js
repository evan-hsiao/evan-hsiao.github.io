import{_ as s,o as n,c as a,a as l}from"./app.ab2e6989.js";const i=JSON.parse('{"title":"資料表與資料表連結","description":"","frontmatter":{},"headers":[{"level":2,"title":"安裝","slug":"安裝","link":"#安裝","children":[]},{"level":2,"title":"取得第一個資料表","slug":"取得第一個資料表","link":"#取得第一個資料表","children":[]},{"level":2,"title":"放到另一個資料表","slug":"放到另一個資料表","link":"#放到另一個資料表","children":[]}],"relativePath":"backend_develop/fastapi/db_to_db.md","lastUpdated":1685410736000}'),p={name:"backend_develop/fastapi/db_to_db.md"},o=l(`<h1 id="資料表與資料表連結" tabindex="-1">資料表與資料表連結 <a class="header-anchor" href="#資料表與資料表連結" aria-hidden="true">#</a></h1><p>使fastapi連接mysql，使用pymysql連接，取得資料庫內A資料表的所有內容</p><p>使用chatGPT回答，未測試。</p><h2 id="安裝" tabindex="-1">安裝 <a class="header-anchor" href="#安裝" aria-hidden="true">#</a></h2><blockquote><p>pip install pymysql</p></blockquote><h2 id="取得第一個資料表" tabindex="-1">取得第一個資料表 <a class="header-anchor" href="#取得第一個資料表" aria-hidden="true">#</a></h2><p>導入必要的模塊和套件：在你的程式中導入 fastapi 和 pymysql 套件：</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> fastapi </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> FastAPI</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pymysql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">app </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FastAPI</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># MySQL 連接資訊</span></span>
<span class="line"><span style="color:#A6ACCD;">host </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_mysql_host</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">user </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_username</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">password </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_password</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">database </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your_database</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 路由和處理程序</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_root</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 建立 MySQL 連接</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pymysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">host</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">host</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">user</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">user</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">password</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">password</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">database</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">database</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 創建游標</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cursor</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 執行 SQL 查詢</span></span>
<span class="line"><span style="color:#A6ACCD;">    query </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SELECT * FROM A;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 取得查詢結果</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> cursor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fetchall</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 關閉游標和連接</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 啟動應用程式</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> __name__ </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">__main__</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> uvicorn</span></span>
<span class="line"><span style="color:#A6ACCD;">    uvicorn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">host</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">0.0.0.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">port</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8000</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>請替換 host、user、password 和 database 的值為你的 MySQL 連接資訊和資料庫名稱。在路由處理程序中，我們建立了 MySQL 連接，創建游標，執行 SQL 查詢並取得結果。最後，我們關閉游標和連接，並將結果返回。</p><p>請確保已安裝了 pymysql 套件，並使用正確的 MySQL 連接資訊以及相應的資料表名稱和欄位名稱來修改程式碼。</p><h2 id="放到另一個資料表" tabindex="-1">放到另一個資料表 <a class="header-anchor" href="#放到另一個資料表" aria-hidden="true">#</a></h2><p>要將資料庫 A 資料表的所有資料放到資料庫 B 的 A 資料表中，你可以按照以下步驟進行：</p><p>確保已經建立了資料庫 B，其中包含與資料庫 A 的 A 資料表結構相同的表。</p><p>修改前一個範例中的 read_root 路由處理程序</p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_root</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 建立資料庫 A 的 MySQL 連接</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn_source </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pymysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">host</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">host</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">user</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">user</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">password</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">password</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">database</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 建立資料庫 B 的 MySQL 連接</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn_destination </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pymysql</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">host</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">host</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">user</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">user</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">password</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">password</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">database</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">B</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 創建資料庫 A 的游標</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor_source </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> conn_source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cursor</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 創建資料庫 B 的游標</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor_destination </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> conn_destination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cursor</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 執行 SQL 查詢 (從資料庫 A 取得資料)</span></span>
<span class="line"><span style="color:#A6ACCD;">    query </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SELECT * FROM A;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor_source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 取得查詢結果</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> cursor_source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fetchall</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 將資料插入到資料庫 B 的 A 資料表</span></span>
<span class="line"><span style="color:#A6ACCD;">    insert_query </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">INSERT INTO A (column1, column2, column3) VALUES (</span><span style="color:#F78C6C;">%s</span><span style="color:#C3E88D;">, </span><span style="color:#F78C6C;">%s</span><span style="color:#C3E88D;">, </span><span style="color:#F78C6C;">%s</span><span style="color:#C3E88D;">);</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> row </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        cursor_destination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">insert_query</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> row</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 提交變更</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn_destination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">commit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 關閉游標和連接</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor_source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    cursor_destination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn_source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    conn_destination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Data transferred successfully</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>這段程式碼假設資料庫 B 中的 A 資料表具有與資料庫 A 中的 A 資料表相同的結構，包含三個欄位 (column1, column2, column3)。請根據實際情況進行修改。</p><p>程式碼中，我們首先建立了兩個 MySQL 連接，分別是資料庫 A 的連接 (conn_source) 和資料庫 B 的連接 (conn_destination)。然後，我們分別創建了兩個游標 (cursor_source 和 cursor_destination)。</p><p>接著，我們執行 SQL 查詢，從資料庫 A 中取得資料。然後，使用 INSERT INTO 語句將資料插入到資料庫 B 的 A 資料表中。</p><p>最後，我們提交變更並關閉游標和連接。當你呼叫 / 路由時，資料將從資料庫 A 的 A 資料表中提取並放置到資料庫 B 的 A 資料表中。</p>`,19),e=[o];function t(c,r,y,D,F,A){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{i as __pageData,u as default};
